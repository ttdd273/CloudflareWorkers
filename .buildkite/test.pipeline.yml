steps:
  - label: ":nodejs: Test All Workers (Main Branch)"
    # dirs=$(find . -maxdepth 1 -type d -name '*worker*')
    command: |
      echo "Setting up Node.js environment..."
      
      pwd

      dirs=$(find . -maxdepth 1 -type d)

      echo $dirs
      echo "Running tests for all workers ${dirs}"

      for dir in $dirs; do
        echo "Testing worker: $dir"
        cd $dir
        npm ci
        npm test
        cd ..
      done

  - wait: ~

  - trigger: "cloudflare-worker-canary-ramp"
    label: ":rocket: Trigger Deployment Pipeline"
    build:
      message: "Tests passed, triggering deployment"
      commit: "${BUILDKITE_COMMIT}"
      branch: "${BUILDKITE_BRANCH}"