steps:
  - label: "Clean up Docker Resources Before Test"
    command: |
      docker-compose -f docker/docker-compose.test.yml down --volumes --rmi all
      docker volume prune -f

  - label: ":nodejs: Test All Workers (Main Branch)"
    command: |
      ./scripts/test_all.sh
    plugins:
    - docker-compose#v3.0.3:
        run: worker-test
        config: docker/docker-compose.test.yml

  # - wait: ~

  # - trigger: "cloudflare-worker-canary-ramp"
  #   label: ":rocket: Trigger Deployment Pipeline"
  #   build:
  #     message: "Tests passed, triggering deployment"
  #     commit: "${BUILDKITE_COMMIT}"
  #     branch: "${BUILDKITE_BRANCH}"